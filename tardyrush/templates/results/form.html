{% extends "layout.html" %}

{% block head %}

<script type="text/javascript">

function submit_forfeit(v) {
    var i = '<input type="hidden" name="forfeit_result" value="'+v+'" />';
    $('#special').after(i);
    return true;
}

$(document).ready(function($) {
    update_final_result();
    $('#forfeit_win').click(function() {
        return submit_forfeit(1);
    });
    $('#forfeit_loss').click(function() {
        return submit_forfeit(0);
    });
});

var player_options = '{%- for pid, pn in player_choices -%}<option value="{{pid}}">{{pn}}</option>{%- endfor -%}';

var map_options = '{%- for pid, pn in map_choices -%}<option value="{{pid}}">{{pn}}</option>{%- endfor -%}';

var side_options = '{%- for pid, pn in side_choices -%}<option value="{{pid}}">{{pn}}</option>{%- endfor -%}';

var gametype_options = '{%- for pid, pn in gametype_choices -%}<option value="{{pid}}">{{pn}}</option>{%- endfor -%}';

function update_final_result() {
    var wins = 0;
    $('input.round_wins_input').each(function(index) {
        wins += parseInt(this.value);
    });
    var losses = 0;
    $('input.round_losses_input').each(function(index) {
        losses += parseInt(this.value);
    });
    var draws = 0;
    $('input.round_draws_input').each(function(index) {
        draws += parseInt(this.value);
    });

    var res;
    if (wins > losses)
        res = "Win";
    else if (wins < losses)
        res = "Loss";
    else
        res = "Draw";
    var by_score = res + ", " + wins + " - " + losses;
    if (draws) by_score += " - " + draws;

    wins = 0;
    losses = 0;
    draws = 0;

    for (var i = 0; i < 1000; ++i) {
        var wid = "#rounds-" + i + "-wins";
        var lid = "#rounds-" + i + "-losses";
        var wsel = $(wid);
        var lsel = $(lid);

        if (!wsel.length || !lsel.length) break;

        var w = parseInt(wsel.val());
        var l = parseInt(lsel.val());

        if (w > l)
            ++wins;
        else if (w < l)
            ++losses;
        else
            ++draws;
    }

    var res;
    if (wins > losses)
        res = "Win";
    else if (wins < losses)
        res = "Loss";
    else
        res = "Draw";
    var by_round = res + ", " + wins + " - " + losses;
    if (draws) by_round += " - " + draws;

    var opts = $('#final_result_method option');
    for (var i = 0; i < opts.length; ++i) {
        if (opts[i].value == 1) {
            opts[i].innerHTML = "By Score ("+by_score+")";
        }
        else if (opts[i].value == 2) {
            opts[i].innerHTML = "By Round ("+by_round+")";
        }
    }
}

function add_results_player(round) {
    var player = $('#round_players_table_' + round + ' tr').length - 1;

    var pid = "rounds-" + round + "-players-" + player + "-user_id";
    var p = "<td><select name='"+pid+"' id='"+pid+"'>" + player_options 
        + "</select></td>";
    var k = "<td><input type='text' size='4' name='rounds-" + round + "-players-" + 
        player + "-kills' value='0' /></td>";
    var d = "<td><input type='text' size='4' name='rounds-" + round + "-players-" + 
        player + "-deaths' value='0' /></td>";
    var oo = "<td><input type='text' size='4' name='rounds-" + round + "-players-" + 
        player + "-off_objs' value='0' /></td>";
    var de = "<td><input type='text' size='4' name='rounds-" + round + "-players-" + 
        player + "-def_objs' value='0' /></td>";
    var s = "<td><input type='text' size='4' name='rounds-" + round + "-players-" + 
        player + "-score' value='0' /></td>";

    var row = "<tr>" + p + k + d + oo + de + s + "</tr>" 

    $('#round_players_table_' + round).append(row);
}

function remove_results_player(round) {
    var rows = $('#round_players_table_' + round + ' tr').length - 1;

    if (rows > 1)
        $('#round_players_table_' + round + ' tr:last').remove();
}

function remove_results_round() {
    var round_num = $('#rounds_container .round').length;
    if (round_num > 1)
        $('#round_' + round_num).remove();
}

function add_results_round() {
    var round_num = $('#rounds_container .round').length;
    var name_start = "rounds-" + round_num + "-";
    var rhtml = '';
    rhtml += '<div class="round" id="round_'+(round_num+1)+'">';
    rhtml += '<h3>Round ' + (round_num+1) + '</h3>';
    rhtml += '<table class="round_map">';
    rhtml += '<tr>';
    rhtml += '<th>Map</th>';
    rhtml += '<th>Side</th>';
    rhtml += '<th>Gametype</th>';
    rhtml += '</tr>';
    rhtml += '<tr>';
    rhtml += '<td><select name="'+name_start+'map_id">'+map_options+'</select></td>';
    rhtml += '<td><select name="'+name_start+'side_id">'+side_options+'</select></td>';
    rhtml += '<td><select name="'+name_start+'gametype_id">'+gametype_options+'</select></td>';
    rhtml += '</tr>';
    rhtml += '</table>';

    rhtml += '<table class="round_score">';
    rhtml += '<tr>';
    rhtml += '<th>Wins<br/><span>(Points For)</span></th>';
    rhtml += '<th>Losses<br/><span>(Points Against)</span></th>';
    rhtml += '<th>Draws</th>';
    rhtml += '</tr>';
    rhtml += '<tr>';
    rhtml += '<td><input class="round_wins_input" type="text" name="'+name_start+'wins" id="'+name_start+'wins" value="0" /></td>';
    rhtml += '<td><input class="round_losses_input" type="text" name="'+name_start+'losses" id="'+name_start+'losses" value="0" /></td>';
    rhtml += '<td><input class="round_draws_input" type="text" name="'+name_start+'draws" id="'+name_start+'draws" value="0" /></td>';
    rhtml += '</tr>';
    rhtml += '</table>';
    rhtml += '<div class="round_players">';
    rhtml += '<table id="round_players_table_' + round_num +'">';

    rhtml += '<caption>';
    rhtml += '<div class="results_player_js_link">';
    rhtml += '<a href="#" onClick="add_results_player('+round_num+');return false;">add player</a> ';
    rhtml += '<a href="#" onClick="remove_results_player('+round_num+');return false;">remove player</a>';
    rhtml += '</caption>';

    rhtml += '<tbody>';
    rhtml += '<tr>';
    rhtml += '<th>Player</th>';
    rhtml += '<th>Kills</th>';
    rhtml += '<th>Deaths</th>';
    rhtml += '<th>Offensive<br/>Objectives</th>';
    rhtml += '<th>Defensive<br/>Objectives</th>';
    rhtml += '<th>Score</th>';
    rhtml += '</tr>';
    rhtml += '</tbody>';
    
    rhtml += '</table>';

    rhtml += '</div>';
    rhtml += '</div>';

    $('#rounds_container').append(rhtml);
    add_results_player(round_num);
    add_results_player(round_num);
    add_results_player(round_num);
    add_results_player(round_num);
}

</script>

{% endblock %}

{% block body %}
  <h2>{% if adding %}Add Results{%else%}Edit Results{%endif%}</h2>
  <form id="results_form" action="" method=post>
    <input type="hidden" name="from" value="{{ request.values.get('from') }}"/>
    {{ form.hidden_tag() }}

    {% if form.errors %}
        <p>Uh oh! Please fix the errors below and try again.</p>
    {% endif %}

    {% for field in form if field.type != 'HiddenField' and field.type !=
    'HiddenIntegerField' -%}
        {% if field.type == 'FieldList' %}

        {% elif field.type != 'FieldList' %}
            {% if field.name == 'team_id' and field.choices|count == 1 %}
                <input type="hidden" name="{{field.name}}" 
                    value="{{ field.choices[0][0] }}"/>
            {% elif field.name != 'final_result_method' %}
            <p>
                {{ field.label }}
                {% if field.name == 'date_played' -%}
                <span>(in {{ field.data|fmt_datetime('zzzz') }})</span>
                {%- endif -%}
                <br/>
                {% if field.errors -%}
                    <div class="errors">
                    <ul>
                    {% for error in field.errors %}<li>{{error}}</li>{% endfor -%}
                    </ul>
                    </div>
                {% endif -%}
                {% if field.name == 'opponent_id' or 
                    field.name == 'server_id' or 
                    field.name == 'competition_id' %}
                    {{ field(disabled='disabled') }}
                {% else %}
                    {{ field }}
                {% endif -%}

                {% if field.name == 'date_played' -%}
                <span>{{ field.data|fmt_datetime('zzz') }}</span>
                {% endif -%}
            </p>
            {% endif %}
        {% endif %}
    {% endfor -%}

    <div id="special">
    <label>Was this a forfeit?</label><br/>
    <input type="submit" name="forfeit_win" id="forfeit_win" value="Forfeit Win"/>
    <input type="submit" name="forfeit_loss" id="forfeit_loss" value="Forfeit Loss"/>
    </div>

    <div id="rounds_container">
    <h2>Rounds</h2>
    {% set field = form.rounds %}
    {% set ct = 1 %}
    {% for f in field %}
        {% if f.type == 'FormField' %}
            <div class="round" id="round_{{ct}}">
            <h3>Round {{ ct }}</h3>
            <table class="round_map">
            <tr>
            <th>{{ f.map_id.label.text }}</th>
            <th>{{ f.side_id.label.text }}</th>
            <th>{{ f.gametype_id.label.text }}</th>
            </tr>

            <tr>
            <td>{{ f.map_id }}</td>
            <td>{{ f.side_id }}</td>
            <td>{{ f.gametype_id }}</td>
            </tr>
            </table>

            <table class="round_score">
            <tr>
            <th>{{ f.wins.label.text }}<br/><span>(Points For)</span></th>
            <th>{{ f.losses.label.text }}<br/><span>(Points Against)</span></th>
            <th>{{ f.draws.label.text }}</th>
            </tr>

            <tr>
            <td>{{ f.wins(onBlur="update_final_result();", class="round_wins_input") }}</td>
            <td>{{ f.losses(onBlur="update_final_result();", class="round_losses_input") }}</td>
            <td>{{ f.draws(onBlur="update_final_result();", class="round_draws_input") }}</td>
            </tr>
            </table>

            <div class="round_players">
            <table id="round_players_table_{{ct-1}}">

            <caption class="results_player_js_link">
                <a href="#" onClick="add_results_player({{ct-1}});return false;">add player</a> 
                <a href="#"
                onClick="remove_results_player({{ct-1}});return false;">remove player</a>
            </caption>

            <tbody>
            <tr>
            <th>Player</th>
            <th>Kills</th>
            <th>Deaths</th>
            <th>Offensive<br/>Objectives</th>
            <th>Defensive<br/>Objectives</th>
            <th>Score</th>
            </tr>
            
            {% for fp in f.players %}
                <tr>
                <td>{{ fp.user_id }}</td>
                <td>{{ fp.kills }}</td>
                <td>{{ fp.deaths }}</td>
                <td>{{ fp.off_objs }}</td>
                <td>{{ fp.def_objs }}</td>
                <td>{{ fp.score }}</td>
                </tr>
            {%- endfor -%}
            </tbody>

            </table>
            </div>
            </div>

            {% set ct = ct + 1 %}
        {% endif -%}
        {% if loop.last %}

        {% endif %}
    {% endfor %}
    </div>

    <div id="round_js_links">
        <a href="#" onClick="add_results_round();return false;">add 
        round</a>

        <a href="#" onClick="remove_results_round();return false;">remove
        round</a>
    </div>

    <div id="final_results">
    <h2>Final Result</h2>
        {{ form.final_result_method(onMouseOver="update_final_result();") }}
    </div>

    <p>
      <input type="submit" name="submit" 
        value="{%- if adding %}Add Results{%else%}Save Results{%endif%}">
    </p>
  </form>

    {% if match_id %}
    <p>
    <h2>Delete Results</h2>
        <form method="post" action="{{url_for('show_match', match_id=match_id,
        action='delete')}}">
        <input type="submit" value="Delete Match"/>
        </form>
    </p>
    {% endif %}
{% endblock %}

